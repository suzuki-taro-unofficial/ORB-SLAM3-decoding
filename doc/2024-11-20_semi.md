# 2024-11-20 報告会

## 全体

- リファクタリング
  - KeyFrame, MapPoint, Mapなどこれまであまり触っていなかった部分についてunusedなものを大掃除（-1500行
- ネットワーク設計
  - GBA周り
    - GBAのスレッドを管理するモジュール（クラスタを作成
  - Atlasの扱いの大幅な変更
    - Atlas自体はセルの値として取り回す方針
    - 各モジュールから新しいAtlasを受取り更新するモジュールを作成
  - Queueの仕組みを変更
    - メモリを参照してネットワークを接続しないようにしていたが、その必要がないのでキューをセルの値として保持するように
- 実装
  - Queueの修正
  - GBAManager: GBAを管理すモジュール
  - ImmutableAtlas: 永続データ構造のような形のAtlas
    - 保持しているマップのポインタが変更された新しいImmutableAtlasを返すなど
    - ただし所持しているMapに対し副作用が行われたとしても感知しない
  - AtlasManager
    - ImmutbleAtlasを各モジュールから受取り、セルに格納し、グローバルループを通して各モジュールに提供する

### ネットワークについて

### GBAManager説明

#### 状態

内部的に3つの状態を保持する

- c_updateInfo
  - GBAが終了し、マップの更新が可能かをマップのポインタのoptionalで保持するセル
- c_runInfo
  - GBAを要求された最新のマップのポインタをoptionalで保持するセル
- c_thread
  - 現在動作しているスレッドのポインタと、スレッドの処理を中断させるフラグをoptionalで保持するセル

#### 入力

入力として以下のストリームとセルを受け取る

- s_tick
  - 発火した際に、c_runInfoにGBAをするマップが存在し、かつc_updateInfoに更新するべきマップが存在しない場合にGBAを起動させる
- s_stopGBA
  - 発火した際にc_threadで走っているスレッドを中断した後joinして終了まで待つ
  - c_threadをnoneで更新する
- s_runGBA
  - GBAを行うマップの情報を持って発火し、その際にc_runInfoをその情報で更新する
- c_isLMStopped
  - ローカルマッピングが停止しているかを保持するセル

#### 出力

出力として以下のストリームが存在する

- s_stopLM
  - マップの更新処理を行う際にLMを停止させるために発火させるストリーム
- s_releaseLM
  - 停止させたLMを復帰させるために発火させるストリーム

#### 動作

動作は主にs_tickによって行われる。動作は以下のようになっている。

- c_runInfoに情報がある
  - c_updateInfoに情報がない場合
    - 新たにスレッドを起動する
    - この際、別スレッドが走っているなら止めてから起動する
  - c_updateInfoに情報がある
    - c_isLMStoppedがfalse
      - LMに対して停止を要求するストリームを発火させる
    - c_isLMStoppedがtrue
      - 情報を用いてキーフレームやマップポイントの情報を更新する
      - 更新後、LMの再開を要求するストリームを発火させる
- c_runInfoに情報が無い
  - c_updateInfoに情報が無いなら何も行わない
  - そうでないなら、上と同じ動作を行う

## KATO

## FUJIWARA

## YAMAKI
